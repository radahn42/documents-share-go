version: "3"

dotenv:
  - .env

vars:
  BIN_DIR: "{{.ROOT_DIR}}/bin"
  MIGRATOR_BIN: "{{.BIN_DIR}}/migrator"

tasks:
  install-migrate-cli:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç golang-migrate CLI –≤ ./bin"
    cmds:
      - |
        if [ ! -f "{{.MIGRATE_BIN}}" ]; then
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º golang-migrate CLI..."
          GOBIN="{{.BIN_DIR}}" go install github.com/golang-migrate/migrate/v4/cmd/migrate@latest
        else
          echo "golang-migrate CLI —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        fi
    status:
      - test -x "{{.MIGRATE_BIN}}"

  build-migrator:
    desc: "–°–æ–±–∏—Ä–∞–µ—Ç –º–∏–≥—Ä–∞—Ç–æ—Ä –≤ bin/migrator"
    cmds:
      - mkdir -p "{{.BIN_DIR}}"
      - go build -o "{{.MIGRATOR_BIN}}" ./cmd/migrator

  migrate-create:
    desc: "–°–æ–∑–¥–∞–µ—Ç –ø–∞—Ä—É –ø—É—Å—Ç—ã—Ö SQL-—Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–∏"
    deps: [install-migrate-cli]
    cmds:
      - bash ./scripts/migrate_create.sh

  migrate-up:
    desc: "–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (up)"
    deps: [build-migrator]
    cmds:
      - '{{.MIGRATOR_BIN}} -dir file://./migrations -dsn "$DATABASE_URL" -action up'

  migrate-down:
    desc: "–û—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (down)"
    deps: [build-migrator]
    cmds:
      - '{{.MIGRATOR_BIN}} -dir file://./migrations -dsn "$DATABASE_URL" -action down'
