version: "3"

dotenv:
  - .env

vars:
  BIN_DIR: "{{.ROOT_DIR}}/bin"
  MIGRATE_BIN: "{{.BIN_DIR}}/migrate"

tasks:
  install-migrate-cli:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç golang-migrate CLI –≤ ./bin"
    cmds:
      - |
        if [ ! -f "{{.MIGRATE_BIN}}" ]; then
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º golang-migrate CLI..."
          mkdir -p "{{.BIN_DIR}}"
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ go install —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π postgres
          GOBIN="{{.BIN_DIR}}" go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest
        else
          echo "‚úÖ golang-migrate CLI —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        fi
    status:
      - test -x "{{.MIGRATE_BIN}}"

  migrate-create:
    desc: "–°–æ–∑–¥–∞–µ—Ç –ø–∞—Ä—É –ø—É—Å—Ç—ã—Ö SQL-—Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–∏"
    deps: [install-migrate-cli]
    cmds:
      - |
        read -p "üìù –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏: " name
        if [ -z "$name" ]; then
          echo "‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
          exit 1
        fi
        echo "üÜï –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏: $name"
        "{{.MIGRATE_BIN}}" create -ext sql -dir migrations -seq "$name"
        echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –≤ ./migrations/"

  migrate-up:
    desc: "–ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (up)"
    deps: [install-migrate-cli]
    cmds:
      - echo "‚¨ÜÔ∏è  –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏..."
      - |
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è migrate CLI –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º localhost –≤–º–µ—Å—Ç–æ postgres
        DB_URL=$(echo "$DATABASE_URL" | sed 's/pgx5/postgres/' | sed 's/@postgres:/@localhost:/')
        "{{.MIGRATE_BIN}}" -path ./migrations -database "$DB_URL" up
      - echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"

  migrate-down:
    desc: "–û—Ç–∫–∞—Ç–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (down)"
    deps: [install-migrate-cli]
    cmds:
      - echo "‚¨áÔ∏è  –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏..."
      - |
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è migrate CLI –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º localhost –≤–º–µ—Å—Ç–æ postgres
        DB_URL=$(echo "$DATABASE_URL" | sed 's/pgx5/postgres/' | sed 's/@postgres:/@localhost:/')
        "{{.MIGRATE_BIN}}" -path ./migrations -database "$DB_URL" down
      - echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –æ—Ç–∫–∞—á–µ–Ω—ã"

  migrate-version:
    desc: "–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –º–∏–≥—Ä–∞—Ü–∏–∏"
    deps: [install-migrate-cli]
    cmds:
      - echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é –º–∏–≥—Ä–∞—Ü–∏–∏..."
      - |
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è migrate CLI –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º localhost –≤–º–µ—Å—Ç–æ postgres
        DB_URL=$(echo "$DATABASE_URL" | sed 's/pgx5/postgres/' | sed 's/@postgres:/@localhost:/')
        "{{.MIGRATE_BIN}}" -path ./migrations -database "$DB_URL" version

  migrate-force:
    desc: "–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é –º–∏–≥—Ä–∞—Ü–∏–∏"
    deps: [install-migrate-cli]
    cmds:
      - |
        read -p "‚ö†Ô∏è  –í–≤–µ–¥–∏—Ç–µ –≤–µ—Ä—Å–∏—é –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏: " version
        if [ -z "$version" ]; then
          echo "‚ùå –í–µ—Ä—Å–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π"
          exit 1
        fi
        echo "üîß –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ—Ä—Å–∏–∏ $version..."
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è migrate CLI –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º localhost –≤–º–µ—Å—Ç–æ postgres
        DB_URL=$(echo "$DATABASE_URL" | sed 's/pgx5/postgres/' | sed 's/@postgres:/@localhost:/')
        "{{.MIGRATE_BIN}}" -path ./migrations -database "$DB_URL" force $version
        echo "‚úÖ –í–µ—Ä—Å–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"

  db-reset:
    desc: "–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (down + up)"
    deps: [install-migrate-cli]
    cmds:
      - echo "üîÑ –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
      - task: migrate-down
      - task: migrate-up
      - echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–±—Ä–æ—à–µ–Ω–∞"

  build:
    desc: "–°–±–æ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"
    cmds:
      - mkdir -p "{{.BIN_DIR}}"
      - echo "üî® –°–±–æ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞..."
      - go build -ldflags="-s -w" -o "{{.BIN_DIR}}/server" ./cmd/server
      - 'echo "‚úÖ –°–µ—Ä–≤–µ—Ä —Å–æ–±—Ä–∞–Ω: {{.BIN_DIR}}/server"'
    sources:
      - "./cmd/server/*.go"
      - "./internal/**/*.go"
    generates:
      - "{{.BIN_DIR}}/server"

  run:
    desc: "–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –ª–æ–∫–∞–ª—å–Ω–æ"
    deps: [build]
    cmds:
      - echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."
      - "{{.BIN_DIR}}/server"

  docker-build:
    desc: "–°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞"
    cmds:
      - echo "üê≥ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
      - docker-compose build
      - echo "‚úÖ –û–±—Ä–∞–∑ —Å–æ–±—Ä–∞–Ω"

  docker-up:
    desc: "–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ Docker"
    cmds:
      - echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
      - docker-compose up -d
      - echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã"

  docker-run:
    desc: "–ó–∞–ø—É—Å–∫ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ (—Å–±–æ—Ä–∫–∞ + –∑–∞–ø—É—Å–∫)"
    cmds:
      - echo "üîß –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
      - docker-compose up --build
      - echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ"

  docker-down:
    desc: "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
    cmds:
      - echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
      - docker-compose down
      - echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

  docker-logs:
    desc: "–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–æ–≤"
    cmds:
      - docker-compose logs -f

  docker-restart:
    desc: "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Docker —Å–µ—Ä–≤–∏—Å–æ–≤"
    cmds:
      - task: docker-down
      - task: docker-up

  docker-clean:
    desc: "–û—á–∏—Å—Ç–∫–∞ Docker (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –æ–±—Ä–∞–∑—ã, volumes)"
    cmds:
      - echo "üßπ –û—á–∏—Å—Ç–∫–∞ Docker..."
      - docker-compose down -v --rmi all
      - docker system prune -f
      - echo "‚úÖ Docker –æ—á–∏—â–µ–Ω"

  fmt:
    desc: "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞"
    cmds:
      - echo "üíÑ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞..."
      - go fmt ./...
      - echo "‚úÖ –ö–æ–¥ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω"

  mod-tidy:
    desc: "–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
    cmds:
      - echo "üì¶ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
      - go mod tidy
      - echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—á–∏—â–µ–Ω—ã"

  deps:
    desc: "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
    cmds:
      - echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
      - go mod download
      - go mod tidy
      - echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

  clean:
    desc: "–û—á–∏—Å—Ç–∫–∞ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤"
    cmds:
      - echo "üßπ –û—á–∏—Å—Ç–∫–∞..."
      - rm -rf "{{.BIN_DIR}}"
      - rm -f coverage.out coverage.html
      - echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

  dev:
    desc: "–ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏"
    cmds:
      - task: deps
      - task: install-migrate-cli
      - task: docker-up
      - echo "üéâ –°—Ä–µ–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –≥–æ—Ç–æ–≤–∞!"
